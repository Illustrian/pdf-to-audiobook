# VPS Demo - Option A: Docker Compose with port publishing
# 
# This compose file runs the PDF-to-Voice demo on a VPS with:
# - Web UI on port 80 (configurable via WEB_PORT)
# - TTS API on port 17777 (configurable via TTS_PORT)
# - Token-based authentication for TTS endpoints
#
# Security notes:
# - TTS_TOKEN must be set and kept secret
# - TTS API is exposed publicly but requires valid token
# - No HTTPS - use a reverse proxy (nginx/traefik/caddy) for production
#
# Usage:
#   export TTS_TOKEN=$(openssl rand -hex 32)
#   export PIPER_MODEL=/path/to/model.onnx
#   docker compose -f deploy/docker-compose.demo.yml up -d

services:
  web:
    build:
      context: ../apps/web
      dockerfile: ../../deploy/Dockerfile.web
    ports:
      - "${WEB_PORT:-80}:80"
    environment:
      - TTS_URL=http://${HOST:-localhost}:${TTS_PORT:-17777}
    restart: unless-stopped
    depends_on:
      - tts
    networks:
      - demo-net

  tts:
    build:
      context: ../apps/tts-local
      dockerfile: ../../deploy/Dockerfile.tts
    ports:
      - "${TTS_PORT:-17777}:17777"
    environment:
      - TTS_TOKEN=${TTS_TOKEN:?TTS_TOKEN must be set}
      - PIPER_MODEL=/app/model/model.onnx
      - PIPER_BIN=piper
      - TTS_CACHE_DIR=/app/cache
      - TTS_HOST=0.0.0.0
      - TTS_PORT=17777
    volumes:
      - tts-cache:/app/cache
      - ${PIPER_MODEL:?PIPER_MODEL must be set}:/app/model/model.onnx:ro
    restart: unless-stopped
    networks:
      - demo-net
    healthcheck:
      test: ["CMD", "curl", "-f", "-H", "X-OC-TTS-TOKEN: ${TTS_TOKEN}", "http://localhost:17777/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  tts-cache:

networks:
  demo-net:
    driver: bridge
